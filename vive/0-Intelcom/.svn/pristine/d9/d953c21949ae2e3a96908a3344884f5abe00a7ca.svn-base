/*
 * Copyright (c) 2014 IMOCOM. All Rights Reserved.
 *
 * This software is the confidential and proprietary information of IMOCOM.
 * ("Confidential Information").
 * It may not be copied or reproduced in any manner without the express
 * written permission of IMOCOM.
 */
package com.imocom.intelcom.view.beans;

import static com.imocom.intelcom.commons.util.CommonConstants.MIDDLEWARE_INTERFACE_TYPE_PROCESS;
import static com.imocom.intelcom.commons.util.CommonConstants.MIDDLEWARE_INTERFACE_TYPE_SERVICE;
import com.imocom.intelcom.persistence.entities.ContadorCotLinea;
import com.imocom.intelcom.persistence.entities.Cotizacion;
import com.imocom.intelcom.persistence.entities.ServiciosEbs;
import com.imocom.intelcom.persistence.entities.Tipo;
import com.imocom.intelcom.ridc.RidcConnectionServiceBean;
import com.imocom.intelcom.services.interfaces.IContadorCotLineaServiceLocal;
import com.imocom.intelcom.services.interfaces.ICotizacionServiceLocal;
import com.imocom.intelcom.services.interfaces.IServiciosEBSLocal;
import com.imocom.intelcom.services.interfaces.ITipoServiceLocal;
import com.imocom.intelcom.services.util.ServiceException;
import com.imocom.intelcom.util.exceptions.UtilException;
import com.imocom.intelcom.util.utility.Constants;
import static com.imocom.intelcom.util.utility.Constants.ATR_OPORTUNIDAD_ACTUALIZACION_ESTADO_OP;
import static com.imocom.intelcom.util.utility.Constants.ATR_OPORTUNIDAD_COTIZACION_ETAPA_OP;
import static com.imocom.intelcom.util.utility.Constants.ATR_OPORTUNIDAD_CREACION_ESTADO_OP;
import static com.imocom.intelcom.util.utility.Constants.ATR_OPORTUNIDAD_CREACION_ETAPA_OP;
import static com.imocom.intelcom.util.utility.Constants.OPORTUNIDAD_ID_PARAM;
import static com.imocom.intelcom.util.utility.Constants.PAGE_COTIZACIONES_CONSULTAR_KEY;
import static com.imocom.intelcom.util.utility.Constants.TIPO_INCOTERM;
import static com.imocom.intelcom.util.utility.Constants.WS_BPM_COTIZACION_CREACION;
import static com.imocom.intelcom.util.utility.Constants.WS_OPORTUNIDAD_NOMBRE_ESTAPA;
import static com.imocom.intelcom.util.utility.Constants.WS_OPORTUNIDAD_NOMBRE_ESTAPA_ESTADO;
import static com.imocom.intelcom.util.utility.Constants.WS_PROCESS_ENTITY_RESULTADO_COTIZACION;
import static com.imocom.intelcom.util.utility.Constants.WS_PRODUCTO_ASOCIADO_OPORTUNIDAD;
import com.imocom.intelcom.util.utility.DateUtil;
import com.imocom.intelcom.util.utility.Utils;
import com.imocom.intelcom.view.AbstractFacesBean;
import com.imocom.intelcom.view.util.CreateDocx;
import com.imocom.intelcom.util.dtos.ClaveValorDTO;
import com.imocom.intelcom.view.vo.SeleccionObjectoDTO;
import com.imocom.intelcom.ws.ebs.vo.entities.CotizacionProductoVO;
import com.imocom.intelcom.ws.ebs.vo.entities.CotizacionesVO;
import com.imocom.intelcom.ws.ebs.vo.entities.OportunidadVO;
import com.imocom.intelcom.ws.ebs.vo.entities.ProductoVO;
import com.imocom.intelcom.ws.ebs.vo.response.OportunidadResponseVO;
import com.imocom.intelcom.ws.ebs.vo.response.ProductosResponseVO;
import com.imocom.intelcom.ws.exception.IntelcomMiddlewareException;
import com.imocom.intelcom.ws.interfaces.jaxws.MiddlewareServiceRequestVO;
import java.io.IOException;
import java.io.InputStream;
import java.io.Serializable;
import java.io.UnsupportedEncodingException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import javax.ejb.EJB;
import javax.el.ValueExpression;
import javax.faces.bean.ManagedBean;
import javax.faces.bean.ViewScoped;
import javax.xml.bind.JAXBException;
import org.apache.log4j.Logger;
import org.primefaces.model.UploadedFile;

/**
 *
 * @author rc
 */
@ManagedBean
@ViewScoped
public class CotizacionesCrearBean extends AbstractFacesBean implements Serializable {

    private static final Logger logger = Logger.getLogger(EventoDetalleFacesBean.class);
    private static final long serialVersionUID = 1L;
    
    private List<Tipo> listaIncoterm;    
    private List<ClaveValorDTO> porcentajeDescuentos;    
    
    /**
     * Parametros para invocar MDW para crear Cotizacion
     */
    private MiddlewareServiceRequestVO request;
    /**
     * Parametros para invocar MDW para Buscar Producto para una oportunidad
     */
    private MiddlewareServiceRequestVO requestProductosOportunidad;
    /**
     * Parametros para invocar MDW para Buscar una oportunidad del asesor
     */
    private MiddlewareServiceRequestVO requestOportunidad;
    /**
     * Parametros para invocar MDW para Buscar una oportunidad por etapa estado
     */
    private MiddlewareServiceRequestVO requestOportunidadesEstapaEstado;
    /**
     * NÃºmero de paramatos para request de Creación de Cotización
     */
    private int numeroParametrosWS = 0;
    /**
     * NÃºmero de parametros para request de busqueda de productos por
     * oportunidad
     */
    private int numeroParamatrosWSProductoOportunidad = 0;
    /**
     * NÃºmero de parametros para request de busqueda de una oportunidad
     */
    private int numeroParamatrosWSOportunidad = 0;
    /**
     * NÃºmero de parametros para request de busqueda de una oportunidad
     */
    private int numeroParamatrosWSOportunidadEtapaEstado = 0;

    @EJB
    private IServiciosEBSLocal iServiciosESB;

    @EJB
    private ICotizacionServiceLocal iCotizacionService;

    @EJB
    private ITipoServiceLocal iTipoService;

    @EJB
    private IContadorCotLineaServiceLocal IContadorCot;

    /**
     * Conexión al UCM para guardar documento
     */
    private RidcConnectionServiceBean iRidcConnection;

    private Cotizacion cotizacion;
    /**
     * listados de productos que se buscan al inventarios
     */
    private List<ProductoVO> productoCotizacion;
    /**
     * Producto que se selecciona para agregar a la cotizacion, ya se a del
     * inventario o de la oportunidad
     */
    private List<ProductoVO> selectProductoCotizacion;

    private ProductoVO productoAgregar;

    private ProductoVO productoBorrar;
    /**
     * ***************************************************************
     */
    /**
     * Lista oportunidades
     */
    private List<OportunidadVO> oportunidades;
    /**
     * Oportunidad Seleccionada para hacer la cotizacion
     */
    private OportunidadVO oportunidadSelect;
    /**
     * Producto de asociada a la oportunidad
     */
    private ProductoVO oportunidadProductoSelect;
    /**
     * Tipo de Oferta de la cotización
     */
    private String tipo;
    /**
     * Archivo de Cargue de Documento para subir al Content Server
     */
    private UploadedFile file;

    private Boolean isTipoPrincipal;
    /**
     * Nombre de las oportunidad a buscar
     */
    private String nombreOportunidadSearch;

    private Boolean agregarProductos;
    /**
     * Booelando que determina si la cotización es automatica o normal
     */
    private Boolean requeiereAprobacion = true;
    
    private Boolean mostrarLinea;
    /**
     * Linea de la cotización: Si el usuario pertenece a linea: VENDEDORES
     * SUCURSALES y VENDEDORES DIVISION METALMECANICA se envia la liena
     * seleccionada, si es diferente se toma la linea de listado de la pantalla
     */
    private String linea;
    
    private String incoterm;
    
    private Long  incotermLong;
    
    private List<ClaveValorDTO> listaRazonCompetenciaDTO;

    public CotizacionesCrearBean() {

    }

    @Override
    protected void build() {
        try {
            armarRequest();
            /**
             * Se verifica si en la session se tiene un objeto oportunidad, Lo que
             * quiere decir que fue invocada la apagina desde el detalle de un
             * oportunidad para solicitar una cotizacion
             */
            if ( getSessionMap().get(OPORTUNIDAD_ID_PARAM) != null) {
                oportunidadSelect = (OportunidadVO) getSessionMap().get(OPORTUNIDAD_ID_PARAM);
                //loadProductosOportunidad();
                
            }
            
            clearProductosList();
            
            if( getSessionMap().get( "PRODUCTO_OPORTUNIDAD_VO_SELECIONADO") != null ){
                
                List<SeleccionObjectoDTO> listaPA = (List)getSessionMap().get( "PRODUCTO_OPORTUNIDAD_VO_SELECIONADO");
                if(listaPA != null ){
                    for (SeleccionObjectoDTO seleccionObjectoDTO : listaPA) {
                        if( seleccionObjectoDTO.isSeleccionado() ){
                            productoAgregar = seleccionObjectoDTO.getProductoVO();
                            agregarProducto();
                        }
                    }
                }
                getSessionMap().remove("PRODUCTO_OPORTUNIDAD_VO_SELECIONADO");
            }
            listaIncoterm = iTipoService.findByTipoNombre(TIPO_INCOTERM);
            
            porcentajeDescuentos = new ArrayList<ClaveValorDTO>();
            
            for (int i = 1; i <= 100; i++) {
                porcentajeDescuentos.add( new ClaveValorDTO( i , i+"%" ));
            }
            
            listaRazonCompetenciaDTO = new ArrayList<ClaveValorDTO>();
            List<Tipo> listaTipo = iTipoService.findByTipoNombre(Constants.TIPO_RAZON_COMPETENCIA_OPORTUNIDAD);
            for (Tipo unTipo : listaTipo) {
                listaRazonCompetenciaDTO.add( new ClaveValorDTO( unTipo.getTipoValor(), unTipo.getTipoEtiqueta()));
            }
            
            cotizacion = new Cotizacion();
        } catch (ServiceException ex) {
            ex.printStackTrace();
        }
    }

    public String agregarProducto() {
        
        if( productoAgregar != null ){
            productoCotizacion.remove(productoAgregar);
            if (!selectProductoCotizacion.contains(productoAgregar)) {
                selectProductoCotizacion.add(productoAgregar);
            }
            productoAgregar = null;
        }        
        return null;
    }

    public String borrarProducto() {
        selectProductoCotizacion.remove(productoBorrar);
        if (!productoCotizacion.contains(productoBorrar)) {
            productoCotizacion.add(productoBorrar);
        }
        return null;
    }

    /**
     * Metodo que retorn los tipos de Oferta para una cotizacion
     *
     * @return
     */
    public List<Tipo> getTipoOfertaCotizacion() {
        List<Tipo> tipoOferta = null;
        try {
            tipoOferta = iTipoService.findByTipoNombre("TIPO_OFERTA");
        } catch (ServiceException ex) {
            logger.error("Error Capturando los Tipos de Ofertas para una cotizacion " + ex.getMessage());
        }
        return tipoOferta;
    }

    /**
     * Metodo que retorn los tipos de Oferta para una cotizacion
     *
     * @return
     */
    public List<ContadorCotLinea> getContadorCotLinea() {
        List<ContadorCotLinea> contadorCotLinea = null;
        contadorCotLinea = IContadorCot.buscarLienas();
        return contadorCotLinea;
    }

    private void armarRequest() {
        try {
            /**
             * Se arma Request para crear cotización en la EBS a travez del MDW
             */
            request = new MiddlewareServiceRequestVO();
            ServiciosEbs servicio = iServiciosESB.findByUniqueName(WS_BPM_COTIZACION_CREACION);
            request.setEndpoint(servicio.getInterfazEndpoint());
            request.setMethod(servicio.getMetodo());
            request.setNamespacePort(servicio.getNamespace());
            request.setServiceName(servicio.getQnameServicio());
            request.setWsdlUrl(servicio.getUrlWsdl());
            request.setInterfaceType(MIDDLEWARE_INTERFACE_TYPE_PROCESS);
            //Cargamos el nÃºmero de parametros
            numeroParametrosWS = servicio.getNumeroParametros();

            /**
             * Se arma Request para buscar productos de una oportunidad
             */
            requestProductosOportunidad = new MiddlewareServiceRequestVO();
            ServiciosEbs servicioPP = iServiciosESB.findByUniqueName(WS_PRODUCTO_ASOCIADO_OPORTUNIDAD);
            requestProductosOportunidad.setEndpoint(servicioPP.getInterfazEndpoint());
            requestProductosOportunidad.setMethod(servicioPP.getMetodo());
            requestProductosOportunidad.setNamespacePort(servicioPP.getNamespace());
            requestProductosOportunidad.setServiceName(servicioPP.getQnameServicio());
            requestProductosOportunidad.setWsdlUrl(servicioPP.getUrlWsdl());
            requestProductosOportunidad.setInterfaceType(MIDDLEWARE_INTERFACE_TYPE_SERVICE);
            //Cargamos el nÃºmero de parametros
            numeroParamatrosWSProductoOportunidad = servicioPP.getNumeroParametros();

            /**
             * Se arma Request para buscar una oportunidad
             */
            requestOportunidad = new MiddlewareServiceRequestVO();
            ServiciosEbs servicioP = iServiciosESB.findByUniqueName(WS_OPORTUNIDAD_NOMBRE_ESTAPA);
            requestOportunidad.setEndpoint(servicioP.getInterfazEndpoint());
            requestOportunidad.setMethod(servicioP.getMetodo());
            requestOportunidad.setNamespacePort(servicioP.getNamespace());
            requestOportunidad.setServiceName(servicioP.getQnameServicio());
            requestOportunidad.setWsdlUrl(servicioP.getUrlWsdl());
            requestOportunidad.setInterfaceType(MIDDLEWARE_INTERFACE_TYPE_SERVICE);
            //Cargamos el nÃºmero de parametros
            numeroParamatrosWSOportunidad = servicioP.getNumeroParametros();
            
            requestOportunidadesEstapaEstado = new MiddlewareServiceRequestVO();
            ServiciosEbs servicioOpEtapaEstado = iServiciosESB.findByUniqueName(WS_OPORTUNIDAD_NOMBRE_ESTAPA_ESTADO);
            requestOportunidadesEstapaEstado.setEndpoint(servicioOpEtapaEstado.getInterfazEndpoint());
            requestOportunidadesEstapaEstado.setMethod(servicioOpEtapaEstado.getMetodo());
            requestOportunidadesEstapaEstado.setNamespacePort(servicioOpEtapaEstado.getNamespace());
            requestOportunidadesEstapaEstado.setServiceName(servicioOpEtapaEstado.getQnameServicio());
            requestOportunidadesEstapaEstado.setWsdlUrl(servicioOpEtapaEstado.getUrlWsdl());
            requestOportunidadesEstapaEstado.setInterfaceType(MIDDLEWARE_INTERFACE_TYPE_SERVICE);
            //Cargamos el nÃºmero de parametros
            numeroParamatrosWSOportunidadEtapaEstado = servicioOpEtapaEstado.getNumeroParametros();

        } catch (ServiceException ex) {
            logger.error(ex.getMessage());
        }
    }

    /**
     * Método que verifica si el tipo null :Se ingresa a la pagina y el tipo por
     * defecto es prinicipal
     *
     * @return
     */
    private String getChangeTipoOferta() {

        if (this.tipo == null || this.tipo.equals("")) {
            return "Principal";
        }
        return tipo;

    }

    /**
     * Retorna una lista de oportunidades por etapa
     *
     * @param idEtapa
     */
    private List<OportunidadVO> load_oportunidad_etapa(String idEtapa) {
        List<OportunidadVO> _listOEtapa = new ArrayList<OportunidadVO>();
        try {
            String[] paramsService = new String[numeroParamatrosWSOportunidadEtapaEstado];
            paramsService[0] = userSession.getUserLogin();
            paramsService[1] = this.nombreOportunidadSearch != null ? this.nombreOportunidadSearch : "";
            paramsService[2] = idEtapa;
            paramsService[3] = "11";
            requestOportunidadesEstapaEstado.setParams(paramsService);
            String responseStr;
            responseStr = userSession.getClientWs().consumeService(requestOportunidadesEstapaEstado);
            OportunidadResponseVO response = (OportunidadResponseVO) Utils.unmarshal(OportunidadResponseVO.class, responseStr);
            if (response != null && response.getOportunidades() != null) {
                _listOEtapa = response.getOportunidades();
            }
        } catch (IntelcomMiddlewareException ex) {
            logger.error("Error al buscar  una oportunidad, " + ex.getMessage());
        } catch (UtilException ex) {
            logger.error("Error al buscar  una oportunidad, " + ex.getMessage());
        }
        return _listOEtapa;
    }
    
    /**
     * Retorna una lista de oportunidades por etapa
     *
     * @param idEtapa
     */
    private List<OportunidadVO> load_oportunidad_etapa_estado(List<String> idsEtapa,List<String> idsEstado) {
        List<OportunidadVO> _listOEtapaEstado = new ArrayList<OportunidadVO>();
        try {
            
            for(String idEtapa:idsEtapa){
                for(String idEstado:idsEstado){
                    String[] paramsService = new String[numeroParamatrosWSOportunidadEtapaEstado];
                    paramsService[0] = userSession.getUserLogin();
                    paramsService[1] = this.nombreOportunidadSearch != null ? this.nombreOportunidadSearch : "";
                    paramsService[2] = idEtapa;
                    paramsService[3] = idEstado;
                    requestOportunidadesEstapaEstado.setParams(paramsService);
                    String responseStr;
                    responseStr = userSession.getClientWs().consumeService(requestOportunidadesEstapaEstado);
                    OportunidadResponseVO response = (OportunidadResponseVO) Utils.unmarshal(OportunidadResponseVO.class, responseStr);
                    if (response != null && response.getOportunidades() != null) {
                       // _listOEtapaEstado = response.getOportunidades();
                        _listOEtapaEstado.addAll(response.getOportunidades());
                    }
                    
                    
                    
                }
                
            }
            
            Collections.sort(_listOEtapaEstado, new Comparator() {
            @Override
            public int compare(Object o1, Object o2) {
                     OportunidadVO op1= (OportunidadVO) o1;
                     OportunidadVO op2= (OportunidadVO) o2;
                    return op1.getNombreOportunidad().compareTo(op2.getNombreOportunidad());
            }
            });
            
            
        } catch (IntelcomMiddlewareException ex) {
            logger.error("Error al buscar  una oportunidad, " + ex.getMessage());
        } catch (UtilException ex) {
            logger.error("Error al buscar  una oportunidad, " + ex.getMessage());
        }
        return _listOEtapaEstado;
    }

    /**
     * MÃ©todo que carga una lista de oportunidades del asesor
     */
    public void loadOportunidad() {
        //logger.info("Nombre oportunidad a buscar: "+this.nombreOportunidadSearch+" "+numeroParamatrosWSOportunidad);
      /*  oportunidades = new ArrayList<OportunidadVO>();
         String[] paramsService = new String[numeroParamatrosWSOportunidad];
         paramsService[0] = userSession.getUserLogin();
         paramsService[1] = this.nombreOportunidadSearch != null ? this.nombreOportunidadSearch : "";
         paramsService[2] = "";

         requestOportunidad.setParams(paramsService);

         String responseStr;
         try {
         responseStr = userSession.getClientWs().consumeService(requestOportunidad);
         OportunidadResponseVO response = (OportunidadResponseVO) Utils.unmarshal(OportunidadResponseVO.class, responseStr);
         oportunidades = response.getOportunidades();

         } catch (IntelcomMiddlewareException ex) {
         logger.error("Error al buscar  una oportunidad, " + ex.getMessage());
         } catch (UtilException ex) {
         logger.error("Error al buscar  una oportunidad, " + ex.getMessage());
         }*/
        
        
        /*
        gfandino: Se crearon las listas idEtapas y idEstado
        para invocar el nuevo método load_oportunidad_etapa_estado
        */
        List<String> idEtapas =  new ArrayList<String>();
        idEtapas.add(ATR_OPORTUNIDAD_CREACION_ETAPA_OP);
        idEtapas.add(ATR_OPORTUNIDAD_COTIZACION_ETAPA_OP);
        
        List<String> idEstado =  new ArrayList<String>();
        idEstado.add(ATR_OPORTUNIDAD_ACTUALIZACION_ESTADO_OP);
        idEstado.add(ATR_OPORTUNIDAD_CREACION_ESTADO_OP);
        
        oportunidades = new ArrayList<OportunidadVO>();
        oportunidades.addAll(this.load_oportunidad_etapa_estado(idEtapas,idEstado));
        
        //oportunidades.addAll(this.load_oportunidad_etapa(ATR_OPORTUNIDAD_CREACION_ETAPA_OP));
        //oportunidades.addAll(this.load_oportunidad_etapa(ATR_OPORTUNIDAD_COTIZACION_ETAPA_OP));
    }

    public void clearProductosList() {
        selectProductoCotizacion = new ArrayList<ProductoVO>();
        productoCotizacion = new ArrayList<ProductoVO>();
    }

    public void clearInventario() {
        ValueExpression ve = getExpressionFactory().createValueExpression(getELContext(), "#{inventarioConsultaFacesBean}", InventarioConsultaFacesBean.class
        );
        InventarioConsultaFacesBean inventarioConsultaFacesBean = (InventarioConsultaFacesBean) ve.getValue(getELContext());
        if (inventarioConsultaFacesBean != null && inventarioConsultaFacesBean.getListaProductos() != null) {
            inventarioConsultaFacesBean.getListaProductos().clear();
        }
    }

    /**
     * Metodo que que busca un producto asociada por una oportunidad, en este
     * metodo se selecciona la linea asociada a un producto
     */
    public void loadProductosOportunidad() {

        if (selectProductoCotizacion != null) {
            selectProductoCotizacion.clear();

        } else {
            selectProductoCotizacion = new ArrayList<ProductoVO>();
        }
        if (productoCotizacion != null) {
            productoCotizacion.clear();
            clearInventario();
        }
        //Toca buscar la etiqueta para ese tipo Long a traves dle ejeb
        productoCotizacion = new ArrayList<ProductoVO>();

        //Se busca el producto asociado a la oportunidad para 
        //Se la cotizacion es principal se toma el producto y si es alternativa se toma la linea
        String[] paramsService = new String[numeroParamatrosWSProductoOportunidad];
        System.out.println("this.oportunidadSelect.getIdOportunidad() " + this.oportunidadSelect.getIdOportunidad());
        System.out.println("this.oportunidadSelect.getNombreOportunidad() " + this.oportunidadSelect.getNombreOportunidad());
        paramsService[0] = this.oportunidadSelect.getIdOportunidad();
        String cotizable = "";
        if (!this.requeiereAprobacion) {
            cotizable = "1";
        }
        paramsService[1] = cotizable;
        requestProductosOportunidad.setParams(paramsService);
        String responseStr;
        try {
            responseStr = userSession.getClientWs().consumeService(requestProductosOportunidad);
            ProductosResponseVO response = (ProductosResponseVO) Utils.unmarshal(ProductosResponseVO.class, responseStr);
            List<ProductoVO> productoOportunidad = response.getProductos();
            if (productoOportunidad != null && !productoOportunidad.isEmpty()) {
                this.linea = productoOportunidad.get(0).getLinea();
                ValueExpression ve = getExpressionFactory().createValueExpression(getELContext(), "#{inventarioConsultaFacesBean}", InventarioConsultaFacesBean.class);
                InventarioConsultaFacesBean inventarioConsulta = (InventarioConsultaFacesBean) ve.getValue(getELContext());
                inventarioConsulta.listaMarcaPorLineaCot();

                this.mostrarLinea = true;
                oportunidadProductoSelect = productoOportunidad.get(0);
            }
        } catch (IntelcomMiddlewareException ex) {
            logger.error("Error al busar productos de una oportunidad, " + ex.getMessage());
        } catch (UtilException ex) {
            logger.error("Error al busar productos de una oportunidad, " + ex.getMessage());
        }
    }

    /**
     * Se selecciona el producto asociada en una oportunidad, cuando es una
     * cotizacion principal
     */
    public void loadProductos() {
        if ((OportunidadVO) getSessionMap().get(OPORTUNIDAD_ID_PARAM) != null) {
            oportunidadSelect = (OportunidadVO) getSessionMap().get(OPORTUNIDAD_ID_PARAM);
            loadProductosOportunidad();

        }
        String tipoOferta = getChangeTipoOferta();
        if (tipoOferta.equals("Principal")) {
            productoCotizacion.add(oportunidadProductoSelect);
        }
    }

    /**
     * Evento de Creación llamado desde la Pagina
     */
    public void enviarAction() {

        if (enviarSolicitud()) {
            // Se redirecciona a la pagina de consulta
            String outcome = getViewRedirect(PAGE_COTIZACIONES_CONSULTAR_KEY);
            try {
                redirect(navigationFaces.navigation.get(outcome));
            } catch (IOException ex) {
                logger.error(ex.getMessage());
            }

        } else {
            performErrorMessages("Ha ocurrido un problema la solicitud de creación de cotizaciones, no ha podido ser enviada ");
        }
        //logger.info("Productos Seleccionados: " + this.selectProductoCotizacion.size());
        /*for (ProductoVO pr : this.selectProductoCotizacion) {
            logger.info("Productos Seleccionados: " + this.selectProductoCotizacion);
        }*/

    }

    /**
     * Se carga el Archivo en el Content Servers
     * @param is
     * @param filename
     * @param contentType
     * @param tipo
     * @return 
     */
    public HashMap<String, String> upload(InputStream is, String filename, String contentType,String tipo) {
        if (is != null) {
            try {
                logger.info(" *********** Subiendo Documento UCM *********************** ");
                String name = "" + System.currentTimeMillis();
                String title = "COT_" + userSession.getUserLogin() + "_" + oportunidadSelect.getNombreOportunidad();
                iRidcConnection = new RidcConnectionServiceBean(userSession.getRidcUrl(), userSession.getRidcUser(), userSession.getRidcPassword());
                return iRidcConnection.checkingDocsOportunidad(is, filename, name, title, contentType,tipo,this.oportunidadSelect.getIdOportunidad(),this.oportunidadSelect.getNitCliente(),this.userSession.getUserLogin());
            } catch (ServiceException ex) {
                logger.error("Error Subiendo el documento de la cotización al UCM bean: " + ex.getMessage());
                return null;
            }
        } else {
            logger.error("No se ha cargado un documento en la cotización: ");
        }
        return new HashMap<String, String>();
    }

    /**
     * Metodo que valida que si la cotizacion a crear es valida, por la
     * siguientes condiciones: Oferta Principal: No debe tener cotizaciones la
     * oportunidad Oferta Alternatica: Debe tener una cotizacion principal
     *
     * @return
     */
    public Boolean cotizacion_valida_oferta() {
        try {
            Boolean resp = false;
            List<Cotizacion> cotizacionOportunidad = iCotizacionService.buscarCotizacionCliOporVenc(null, Long.parseLong(oportunidadSelect.getIdOportunidad()), null, null, null);
            if (tipo.equals("Principal")) {
                if (cotizacionOportunidad.isEmpty()) {
                    resp = true;
                } else {
                    performErrorMessages("Ya existe un oferta principal para la oportunidad seleccionada, Debe crear una Alternatica");
                }
            } else {
                resp = true;
            }
            /* else {
             if (!cotizacionOportunidad.isEmpty()) {
             for (Cotizacion co : cotizacionOportunidad) {
             if (co.getIdtipooferta().getTipoEtiqueta().equals("Principal")) {
             resp= true;
             }
             }                    
             }
             if(!resp){
             performErrorMessages("No existe un oferta principal, por favor seleccione una");
             }
             }*/
            return resp;

        } catch (ServiceException ex) {
            logger.error("Error Creando una cotización: " + ex.getMessage());
        }
        return false;
    }

    /**
     * Envia una solicitud de crear una cotizacion
     *
     * @return
     */
    public Boolean enviarSolicitud() {

        logger.info("************** Solicitud De Creacion de Cotización ****************************");
        //logger.info("Productos Seleccionados: " + this.selectProductoCotizacion.);
        try {
            if (selectProductoCotizacion == null || selectProductoCotizacion.isEmpty()) {
                performErrorMessages("Debe seleccionar un Producto");
                return false;
            }
            String cantidadProducto = selectProductoCotizacion.get(0).getCantidad();
           if (!Utils.isNumeric(cantidadProducto)){
                performErrorMessages("Cantidad del Producto No es númerica o Contiene espacios.");
                return false;
            }
            if (this.oportunidadSelect == null) {
                performErrorMessages("Debe seleccionar un Oportunidad");
                return false;
            }
            if (this.cotizacion.getCorreo()!=null && !this.cotizacion.getCorreo().equals("")){
                Pattern pat = Pattern.compile("[\\w\\.-]*[a-zA-Z0-9_]@[\\w\\.-]*[a-zA-Z0-9]\\.[a-zA-Z][a-zA-Z\\.]*[a-zA-Z]");
                Matcher mat = pat.matcher(this.cotizacion.getCorreo());
                if (!mat.matches()){
                     performErrorMessages("Formato de Correo no es valido.");
                     return false;
                }
            }
            if (this.cotizacion_valida_oferta()) {
                String nameDocument = "";
                int idDocumentoContent = 0;
                String webLocation = "";
                String codigoCotizacion = "";
                if (this.requeiereAprobacion) {
                    logger.info("Creando Archivo [Requiere Aprobacion]");
                    if (file != null) {
                        nameDocument = file.getFileName();
                        HashMap<String, String> rFile = upload(file.getInputstream(), file.getFileName(), file.getContentType(),"ListaChequeo");
                        if (rFile == null) {
                            idDocumentoContent = -1;
                        } else {
                            if (!rFile.isEmpty()) {
                                idDocumentoContent = Integer.parseInt(rFile.get("id"));
                                webLocation = rFile.get("webLocation");
                            }
                        }
                    }
                }
                if (idDocumentoContent >= 0) {
                    CotizacionesVO cotizacionVO = new CotizacionesVO();
                    cotizacionVO.setNombreUsuario(userSession.getUserLogin());
                    cotizacionVO.setRequiereAprobacion("TRUE");
                    cotizacionVO.setIdOportunidad(this.oportunidadSelect.getIdOportunidad());//HARDCODE ...
                    cotizacionVO.setNombreOportunidad(this.convertirCadena(this.oportunidadSelect.getNombreOportunidad()));//HARDCODE Viene de la oportunidad
                    //cotizacionVO.setNombreOportunidad(this.oportunidadSelect.getNombreOportunidad());//HARDCODE Viene de la oportunidad
                    cotizacionVO.setIdCliente(this.oportunidadSelect.getNitCliente());//HARDCODE Viene de la oportunidad
                    cotizacionVO.setNombreCliente(this.oportunidadSelect.getNombreCliente());//HARDCODE Viene de la oportunidad
                    //cotizacionVO.setNombreCliente(this.oportunidadSelect.getNombreCliente());//HARDCODE Viene de la oportunidad
                    cotizacionVO.setFechLimiteGeneracion(DateUtil.formatBPMTime(this.cotizacion.getFechavencimientosolicitud()));
                    cotizacionVO.setFechaEstimadaEntrega(DateUtil.formatBPMTime(this.cotizacion.getFechaEstimadaEntrega()));
                    cotizacionVO.setFechaEstimadaFacturacion(DateUtil.formatBPMTime(this.cotizacion.getFechaEstimadaFacturacion()));
                    cotizacionVO.setFechaEstimadaPedidoVenta(DateUtil.formatBPMTime(this.cotizacion.getFechaEstimadaPedidoVenta()));
                    if( !requeiereAprobacion ){
                        cotizacionVO.setTieneDescuento(this.cotizacion.getTieneDescuento());
                        cotizacionVO.setPorcentajeDescuento(this.cotizacion.getPorcentajeDescuento().toString());
                    }else{
                        cotizacionVO.setTieneDescuento("NO");
                        cotizacionVO.setPorcentajeDescuento("0");
                    }
                    
                    cotizacionVO.setInteligenciaCompetencia( this.cotizacion.getInteligenciaCompetencia() );
                    cotizacionVO.setInteligenciaObservaciones( this.cotizacion.getInteligenciaObservaciones() );
                    cotizacionVO.setInteligenciaRazon( this.cotizacion.getInteligenciaRazon() );
                    
                    String lineaInput = selectProductoCotizacion.get(0).getLinea();
                    Long tipoId = 0L;
                    try {
                        tipoId = iTipoService.findByEtiqueta(tipo).getIdTipo();
                    } catch (ServiceException ex) {
                        logger.error("Error capturando tipo de Oferta", ex);
                    }
                    Long tipoEstadoCot = 0L;
                    try {
                        tipoEstadoCot = iTipoService.findByEtiqueta("Pendiente").getIdTipo();
                    } catch (ServiceException ex) {
                        logger.error("Error capturando tipo de Estado cot", ex);
                    }
                    if (this.incotermLong==null) {
                        cotizacionVO.setIdInconterm("0");                        
                    }else{
                        cotizacionVO.setIdInconterm(""+this.incotermLong);
                    }
                    
                    
                    cotizacionVO.setTipoOferta(Long.toString(tipoId));
                    cotizacionVO.setIdEstadoCotizacion(Long.toString(tipoEstadoCot));//Estado Pendiente
                    cotizacionVO.setObservAsesor(this.convertirCadena(this.cotizacion.getObservacionasesor()));
                    //cotizacionVO.setObservAsesor(this.cotizacion.getObservacionasesor());
                    cotizacionVO.setDirigida(this.convertirCadena(this.cotizacion.getDirigida()));
                    //cotizacionVO.setDirigida(this.cotizacion.getDirigida());
                    cotizacionVO.setTelefono(this.cotizacion.getTelefono());
                    cotizacionVO.setDireccion(this.cotizacion.getDireccion());
                    cotizacionVO.setCorreo(this.cotizacion.getCorreo());
                    //Verificacion Cotizacion Automatica
                    if (!this.requeiereAprobacion) {
                        cotizacionVO.setRequiereAprobacion("FALSE");
                        logger.info("Creando Archivo Cot Automatica [No Requiere Aprobacion]");
                        String path = "/tmp/";
                        nameDocument = "Cotizacion_" + userSession.getUserLogin() + "_" + System.currentTimeMillis() + ".docx";
                        codigoCotizacion = iCotizacionService.procCoodigoCotizacion(userSession.getUsuario().getLinea());
                        //Se crear HASHMAP, se debe llenar con datos del EBS
                        HashMap<String, String> codReplace = new HashMap<String, String>();
                        codReplace.put("L001CIUDAD", userSession.getUsuario().getCiudad());
                        codReplace.put("L002FECHA", DateUtil.formatShortDateTime(new Date()));
                        codReplace.put("L003NOMBRECLIENTE", oportunidadSelect.getNombreCliente());
                        codReplace.put("L004LINEA", userSession.getUsuario().getLinea());
                        codReplace.put("L0041LINEA", userSession.getUsuario().getLinea());
                        codReplace.put("L005CODCOT", codigoCotizacion);
                        codReplace.put("L006PRODUCTO", selectProductoCotizacion.get(0).getNombre());
                        codReplace.put("L007MARCA", selectProductoCotizacion.get(0).getMarca());
                        codReplace.put("L008GERENTELINEA", "Ing. Gerente Linea");
                        codReplace.put("L009ASESOR", "Ing. " + userSession.getUsuario().getNombre());
                        codReplace.put("L0010LINKIMAGENMAQUINA", selectProductoCotizacion.get(0).getLinkImg());
                        codReplace.put("L0011LINKTEC", selectProductoCotizacion.get(0).getLinkCaracteristicas());
                        codReplace.put("L0012LINKACCESORIOS", selectProductoCotizacion.get(0).getLinkAccesorios());
                        codReplace.put("L0013LINKVIDEO", selectProductoCotizacion.get(0).getLinkVideo());
                        //

                        cotizacionVO.setCodigo(codigoCotizacion);
                        logger.info("Codigo Cotizacion: " + codigoCotizacion);
                        CreateDocx ct = new CreateDocx(codReplace, nameDocument);
                        InputStream is = ct.replace();
                        HashMap<String, String> rFile = upload(is, nameDocument, "application/docx","CotizacionAutomatica");
                        idDocumentoContent = Integer.parseInt(rFile.get("id"));
                        webLocation = rFile.get("webLocation");
                        logger.info("Documento Cargado:  " + idDocumentoContent);
                    } else {
                        cotizacionVO.setRequiereAprobacion("TRUE");
                    }
                    if (idDocumentoContent > 0) {

                        cotizacionVO.setIdArchivoAdjSolicitud(Integer.toString(idDocumentoContent));//UCM
                        cotizacionVO.setNombreArchivoAdjSolicitud(nameDocument);//UCM
                        cotizacionVO.setUrlContentArchivoAdjSolicitud(webLocation); //-agregar cotizacionesVO;      

                    }

                    /*if (getMostrarLinea()) {
                     lineaInput = this.linea;
                     }*/
                    cotizacionVO.setLinea(lineaInput);
                    cotizacionVO.setFechaSolicitud(DateUtil.formatBPMTime(new Date()));//Fecha Actual
                    List<CotizacionProductoVO> listaCotizacionProducto = new ArrayList<CotizacionProductoVO>();

                    for (ProductoVO prd : this.selectProductoCotizacion) {
                        CotizacionProductoVO producto = new CotizacionProductoVO();
                        logger.info("Producto Cantidad: " + prd.getCantidad());
                        logger.info("Valor Unitario: " + prd.getValorUnitario());
                        logger.info("Precion Lista Set Unitario: " + prd.getPrecioListaSinFormato());
                        logger.info("Precion Lista: " + prd.getPrecioLista());
                        producto.setIdProducto(prd.getCodigo());
                        if (prd.getCantidad() == null) {
                            producto.setCantidad("1");
                        } else {
                            producto.setCantidad(prd.getCantidad());
                        }
                        producto.setModelo(prd.getModelo());
                        producto.setMarca(prd.getMarca());

                        producto.setValorUnitario(prd.getPrecioListaSinFormato().equals("") ? "0" : prd.getPrecioListaSinFormato());
                        producto.setNombreProducto(prd.getNombre());
                        cotizacionVO.setIdTipoMoneda("");
                        listaCotizacionProducto.add(producto);
                    }

                    cotizacionVO.setCotizacionProducto(listaCotizacionProducto);
                    //se convierte el objeto a String
                    logger.info("Cotizacion Utils.marshal(cotizacionVO)");
                    String strRequest = Utils.marshal(cotizacionVO);
                    logger.info("Cotizacion Request Linea: " + strRequest);

                    //se pasan los unicos 2 parÃ¡metros
                    String[] paramsService = new String[numeroParametrosWS];
                    paramsService[0] = strRequest;
                    paramsService[1] = WS_PROCESS_ENTITY_RESULTADO_COTIZACION;
                    request.setParams(paramsService);

                    userSession.getClientWs().consumeService(request);
                    return true;
                }
            }
        } catch (IntelcomMiddlewareException ex) {
            logger.error("Error Creando una cotización: " + ex.getMessage(), ex);
            return false;

        } catch (JAXBException ex) {
            logger.error("Error Creando una cotización: " + ex.getMessage(), ex);
            return false;
        } catch (IOException ex) {
            logger.error("Error Creando una cotización: " + ex.getMessage(), ex);
            return false;
        }
        return false;
    }

    /**
     * Busca las productos que se consultan en el inventario, esto aplica cuando
     * es alternativa
     *
     *
     * @return
     */
    public List<ProductoVO> getProductoCotizacion() {
        if (this.getChangeTipoOferta().equals("Alternativa")) {
            if (productoCotizacion != null) {
                productoCotizacion.clear();

            }
            ValueExpression ve = getExpressionFactory().createValueExpression(getELContext(), "#{inventarioConsultaFacesBean}", InventarioConsultaFacesBean.class
            );
            InventarioConsultaFacesBean inventarioConsultaFacesBean = (InventarioConsultaFacesBean) ve.getValue(getELContext());
            if (inventarioConsultaFacesBean
                    != null && inventarioConsultaFacesBean.getListaProductos()
                    != null) {
                productoCotizacion.addAll(inventarioConsultaFacesBean.getListaProductos());
            }
        }
        return productoCotizacion;
    }
    
    private String convertirCadena(String cadena) throws UnsupportedEncodingException{
        return cadena == null ? "" : new String (cadena.getBytes ("iso-8859-1"), "UTF-8");
    }

    public void setProductoCotizacion(List<ProductoVO> productoCotizacion) {
        this.productoCotizacion = productoCotizacion;
    }

    public ProductoVO getProductoAgregar() {
        return productoAgregar;
    }

    public void setProductoAgregar(ProductoVO productoAgregar) {
        this.productoAgregar = productoAgregar;
    }

    public ProductoVO getProductoBorrar() {
        return productoBorrar;
    }

    public void setProductoBorrar(ProductoVO productoBorrar) {
        this.productoBorrar = productoBorrar;
    }

    public List<ProductoVO> getSelectProductoCotizacion() {
        return selectProductoCotizacion;
    }

    public void setSelectProductoCotizacion(List<ProductoVO> selectProductoCotizacion) {
        this.selectProductoCotizacion = selectProductoCotizacion;
    }

    public List<OportunidadVO> getOportunidades() {
        return oportunidades;
    }

    public void setOportunidades(List<OportunidadVO> oportunidades) {
        this.oportunidades = oportunidades;
    }

    public OportunidadVO getOportunidadSelect() {
        return oportunidadSelect;
    }

    public void setOportunidadSelect(OportunidadVO oportunidadSelect) {
        this.oportunidadSelect = oportunidadSelect;
    }

    public Boolean getIsTipoPrincipal() {
        Boolean pr = this.getChangeTipoOferta().equals("Principal");
        return pr;
        //return isTipoPrincipal;
    }

    public void setIsTipoPrincipal(Boolean isTipoPrincipal) {
        this.isTipoPrincipal = isTipoPrincipal;
    }

    public String getNombreOportunidadSearch() {
        return nombreOportunidadSearch;
    }

    public void setNombreOportunidadSearch(String nombreOportunidadSearch) {
        this.nombreOportunidadSearch = nombreOportunidadSearch;
    }

    public Boolean getAgregarProductos() {
        //Si lista esta vacia se puede agregar
        if (this.selectProductoCotizacion == null) {
            return true;
        }
        //Si lista no contiene elemento se puede agregar
        if (this.selectProductoCotizacion.isEmpty()) {
            return true;
        }
        return false;
    }

    public void setAgregarProductos(Boolean agregarProductos) {
        this.agregarProductos = agregarProductos;
    }

    public Boolean getRequeiereAprobacion() {
        return requeiereAprobacion;
    }

    public void setRequeiereAprobacion(Boolean requeiereAprobacion) {
        this.requeiereAprobacion = requeiereAprobacion;
    }

    public String getLinea() {
        return linea;
    }

    public void setLinea(String linea) {
        this.linea = linea;
    }

    public Boolean getMostrarLinea() {
        if (this.userSession.getUsuario().getLinea().equals("VENDEDORES SUCURSALES") || (this.userSession.getUsuario().getLinea().equals("VENDEDORES DIVISION METALMECANICA"))) {
            return true;
        }
        return false;
    }

    public void setMostrarLinea(Boolean mostrarLinea) {
        this.mostrarLinea = mostrarLinea;
    }

    public UploadedFile getFile() {
        return file;
    }

    public void setFile(UploadedFile file) {
        this.file = file;
    }

    public Cotizacion getCotizacion() {
        return cotizacion;
    }

    public void setCotizacion(Cotizacion cotizacion) {
        this.cotizacion = cotizacion;
    }

    public String getTipo() {
        return tipo;
    }

    public void setTipo(String tipo) {
        this.tipo = tipo;
    }

    public List<Tipo> getListaIncoterm() {
        return listaIncoterm;
    }

    public void setListaIncoterm(List<Tipo> listaIncoterm) {
        this.listaIncoterm = listaIncoterm;
    }

    public String getIncoterm() {
        return incoterm;
    }

    public void setIncoterm(String incoterm) {
        this.incoterm = incoterm;
    }

    public Long getIncotermLong() {
        return incotermLong;
    }

    public void setIncotermLong(Long incotermLong) {
        this.incotermLong = incotermLong;
    }

    public List<ClaveValorDTO> getPorcentajeDescuentos() {
        return porcentajeDescuentos;
    }

    public void setPorcentajeDescuentos(List<ClaveValorDTO> porcentajeDescuentos) {
        this.porcentajeDescuentos = porcentajeDescuentos;
    }

    public List<ClaveValorDTO> getListaRazonCompetenciaDTO() {
        return listaRazonCompetenciaDTO;
    }

    public void setListaRazonCompetenciaDTO(List<ClaveValorDTO> listaRazonCompetenciaDTO) {
        this.listaRazonCompetenciaDTO = listaRazonCompetenciaDTO;
    }
    
}
